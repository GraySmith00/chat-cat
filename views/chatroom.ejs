<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChatCat - <%= room %></title>
    <link rel="stylesheet" href="/css/chatroomStyles.css" />
    <script src="/js/jquery-2.1.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(() => {
        const socket = io('<%= host %>' + '/chatter');
        const roomID = '<%= roomID %>';
        const user = '<%= user.fullName %>';
        const userPic = '<%= user.profilePic %>';
        const chatInput = $("input[name='userInput']");
        const chatMessagesDiv = $('.chatMessages');

        socket.on('connect', () => {
          socket.emit('join', {
            roomID,
            user,
            userPic
          });
        });

        const userList = user => {
          return `
                      <div class="userBlock">
                        <div class="userPic">
                          <img src="${user.userPic}" alt="${user.user}" />
                        </div>
                        <div class="cuserName">${user.user}</div>
                      </div>
                      `;
        };

        socket.on('updateUsersList', data => {
          const parsedData = JSON.parse(data);
          let usersListData = '';
          for (let user of parsedData) {
            usersListData += userList(user);
          }
          $('.chatUsers')
            .html('')
            .html(usersListData);
        });

        const updateFeed = (userPic, message) => {
          const template = `
              <div class="chatBlock">
                  <div class="userPic"><img src="${userPic}" /></div>
                  <div class="chatMsg">
                    ${message}
                  </div>
                </div>
              `;
          $(template)
            .hide()
            .prependTo(chatMessagesDiv)
            .slideDown(200);
        };

        $("input[name='userInput']").on('keyup', function(e) {
          e.preventDefault();

          let messageField = $(this);
          if (e.which === 13 && messageField.val() !== '') {
            console.log(this);
            socket.emit('newMessage', {
              roomID,
              user,
              userPic,
              message: messageField.val()
            });

            // update the local feed
            updateFeed(userPic, messageField.val());
            messageField.val('');
          }
        });

        socket.on('inMessage', data => {
          const parsedData = JSON.parse(data);
          updateFeed(parsedData.userPic, parsedData.message);
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="titlePanel"><h1>ChatCAT | <%= room %></h1></div>
      <div class="controls">
        <div class="userPicHolder">
          <img src="<%= user.profilePic %>" alt="John Doe" />
        </div>
        <p class="userName"><%= user.fullName %></p>
        <a href="/rooms" id="roomsBtn">Rooms</a>
        <a href="/logout" id="logOutBtn">Logout</a>
      </div>
      <div class="chatListDiv">
        <div class="chatMessagesPanel">
          <div class="chatMessages">
            <!-- Loop this for chat messages -->

            <!-- loop end -->
          </div>
          <div class="typePanel">
            <input
              type="text"
              name="userInput"
              placeholder="Type here and press enter"
            />
            <a href="#" id="uploadFile" class="fileUploadBtn">Photo</a>
          </div>
        </div>
        <div class="chatUsers">
          <!-- Loop this for chat users -->

          <!-- loop end -->
        </div>
      </div>
    </div>
  </body>
</html>
